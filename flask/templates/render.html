{% extends "layout.html" %}

{% block title %}
    rendering
{% endblock %}

{% block main %}

<h1>ct scans with organ segmentation and resulting 3D model</h1>
<div class="container">
    <div class="slice-container">
        <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
                {% for image_path in image_paths %}
                    <div class="carousel-item {% if loop.first %} active{% endif %}">
                        <div class="card-carousel">
                            <img src="{{ image_path }}" alt="{{ generate_title(image_path) }}">
                            <div class="card-content">
                                <strong>{{ generate_title(image_path) }}</strong>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
        </div>
    </div>
    <div class="model-container" id="model-container"></div>
</div>

<script type="module">
    import * as THREE from '/static/three.module.js';
    import { OrbitControls } from '/static/OrbitControls.js';
    import { OBJLoader } from '/static/OBJLoader.js';
    import { MTLLoader } from '/static/MTLLoader.js';

    // It's fine to include other JavaScript code like initializing Bootstrap components
    document.addEventListener('DOMContentLoaded', function() {
        var myCarousel = new bootstrap.Carousel(document.getElementById('carouselExampleIndicators'), {
            interval: 5000,
            wrap: true,
            pause: 'hover'
        });
    });

    // 3D scene initialization
    window.addEventListener('load', function() {
        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;

        // var renderer = new THREE.WebGLRenderer();
        // renderer.setSize(document.getElementById('model-container').clientWidth, document.getElementById('model-container').clientHeight);
        // document.getElementById('model-container').appendChild(renderer.domElement);

        var container = document.getElementById('model-container');
        var width = container.clientWidth; // Use container width
        var height = width*0.7; // Maintain square aspect ratio
        var renderer = new THREE.WebGLRenderer();
        renderer.setSize(width, height);
        container.appendChild(renderer.domElement);

        var light = new THREE.PointLight(0xFFFFFF, 1, 1000);
        light.position.set(10, 10, 10);
        light.castShadow = true; // Enable shadow casting for the light
        scene.add(light);

        var spotlight = new THREE.SpotLight(0xFFFFFF, 100); // White light with intensity 1
        spotlight.position.set(-20, 0, 10); // Position of the spotlight
        spotlight.castShadow = true; // Enable shadow casting for the spotlight
        scene.add(spotlight);        

        var ambientLight = new THREE.AmbientLight(0x808080);
        scene.add(ambientLight);

        // Load the MTL file
        // var mtlLoader = new MTLLoader();
        // mtlLoader.load('{{ url_for('static', filename='uploads/objs/fixed.mtl') }}', function (materials) {
            // materials.preload();
        var loader = new OBJLoader();
        // loader.setMaterials(materials); // Set the materials loaded from MTL file
        loader.load('{{ url_for('static', filename='uploads/objs/teapot.obj') }}', function (object) {
            
            // console.log('Loaded Object:', object); // Log the loaded object to the console
            // Optionally, you can inspect the object's children to see if materials are assigned
            // console.log('Object Children:', object.children);
        
            scene.add(object);
            object.position.y -= 2.5;
            object.receiveShadow = true; // Enable shadow receiving for the object
            spotlight.target = object;
        });
        // });

        var controls = new OrbitControls(camera, renderer.domElement);
        // Increase the intensity of the point light
        light.intensity = 300;

        // Increase the intensity of the ambient light
        ambientLight.intensity = 2;

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
    });
</script>


{% endblock %}